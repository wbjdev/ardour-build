name: Build Latest Ardour (show version and reuse the ccache)
on: 
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3 pkg-config ccache \
          libboost-all-dev libasound2-dev libglib2.0-dev glibmm-2.4-dev \
          libsndfile1-dev libcurl4-gnutls-dev liblo-dev libtag1-dev \
          vamp-plugin-sdk librubberband-dev libfftw3-dev libaubio-dev \
          libxml2-dev libcwiid-dev libjack-jackd2-dev liblrdf0-dev \
          libsamplerate0-dev lv2-dev libserd-dev libsord-dev \
          libsratom-dev liblilv-dev libgtkmm-2.4-dev libarchive-dev \
          libudev-dev libwebsockets-dev libusb-1.0-0-dev libsuil-dev

      - name: Checkout Ardour
        uses: actions/checkout@v4
        with:
          repository: Ardour/ardour
          path: ardour
          fetch-depth: 0 # Get all tags for versioning

      # This step handles the magic of saving/restoring your compiled files
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ardour-build
          max-size: "2G"

      - name: Configure and Get Version
        id: get_version
        run: |
          cd ardour
          # Tell Waf to use ccache for compilation
          export CC="ccache gcc"
          export CXX="ccache g++"
          ./waf configure --optimize
          
          VER=$(git describe --tags | sed 's/-.*//')
          echo "ARD_VER=$VER" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          cd ardour
          # Ensure the build step also uses ccache
          export CC="ccache gcc"
          export CXX="ccache g++"
          export PATH="/usr/lib/ccache:$PATH"
          ./waf build -j$(nproc)

      - name: Package the Build
        run: |
          cd ardour/tools/linux_packaging
          ./build --public --strip some

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: Ardour-${{ steps.get_version.outputs.ARD_VER }}-Linux
          path: ardour/tools/linux_packaging/*.tar
